name: Build & Deploy to AWS

on:
  push:
    branches: [main]

env:
  FRONTEND_IMAGE: wmdeneth/frontend-app
  BACKEND_IMAGE: wmdeneth/backend-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest
      
      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest

  deploy-to-aws:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Init
        run: cd terraform && terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Terraform Plan
        run: cd terraform && terraform plan -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Terraform Apply
        run: cd terraform && terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Get instance IP
        id: tf_output
        run: |
          cd terraform
          INSTANCE_IP=$(terraform output -raw instance_ip)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
      
      - name: Deploy to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/aws_key
          chmod 600 ~/.ssh/aws_key
          
          SERVER_IP=${{ steps.tf_output.outputs.instance_ip }}
          
          # Wait for SSH to be ready
          for i in {1..30}; do
            ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/aws_key ubuntu@$SERVER_IP "echo 'SSH ready'" && break
            sleep 10
          done
          
          # Copy docker-compose file
          scp -o StrictHostKeyChecking=no -i ~/.ssh/aws_key docker-compose.yml ubuntu@$SERVER_IP:~/
          
          # Deploy
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/aws_key ubuntu@$SERVER_IP '
            docker-compose -f ~/docker-compose.yml pull
            docker-compose -f ~/docker-compose.yml up -d
            docker-compose -f ~/docker-compose.yml ps
          '
          
          echo "âœ… Deployment successful!"
          echo "App available at: http://$SERVER_IP"
